var path = require('path');
var express = require('express');
var fs = require("fs");
var bin2mp4 = require('./bin2mp4');
var router = express.Router();


router.get('/', function(req, res, next) {
    if (req.query.name == null || req.query.type == null || req.query.version == null) {
        res.end('That is not how this page works');
    }
    else {
        var exploit = {
            name: req.query.name,
            type: req.query.type,
            version: req.query.version
        };

        if (!fs.existsSync(path.join(__dirname, '../exploits', exploit.version, exploit.name + exploit.type))) {
            res.send("file not found")
        }
        else
        {
            switch (exploit.type) {
                case ".mp4":
                    res.sendFile(path.join(__dirname, '../exploits', exploit.version, exploit.name + exploit.type));
                    break;
                case ".bin":
                    var bindat = fs.readFileSync(path.join(__dirname, '../exploits', exploit.version, exploit.name + exploit.type));
                    var mp4 = bin2mp4(bindat, 550);
                    res.contentType('video/mp4');
                    res.end(mp4);
            }
        }
    }
});

module.exports = router;
