var path = require('path');
var glob = require('glob');
var express = require('express');
var md5 = require('md5');
var settings = require('./../config.json');
var fs = require("fs");
var router = express.Router();


router.get('/', function(req, res, next) {
    var data = {};
    data.sploits = {};
    data.title = req.query.version;

    var folder = req.query.folder;
    if (folder == null) folder = '$root';
    if (settings.mergeSystemVersions)
    {
        if (req.query.version == 551 || req.query.version == 550)
        {
            var version = 550;
        }
        else if (req.query.version == 540 || req.query.version == 532)
        {
            var version = 532;
        }
    }
    data.version = version;
    if (fs.existsSync(path.join(__dirname, '../exploits', version.toString(), 'filesystem.json')))
    {
        var fsdata = require(path.join(__dirname, '../exploits', version.toString(), 'filesystem.json'));
    }
    else
    {
        var fsdata = {};
    }
    glob.glob(path.join(__dirname, '../exploits', version.toString(), '*.*'), function (err, files) {
        if (err != null) throw err;

        for (var file in files)
        {
            if (path.basename(files[file]) != 'filesystem.json')
            {
                var filename = path.basename(files[file]);
                if (fsdata.hasOwnProperty(filename)) {
                    if (fsdata.exploits[filename].folder == folder)
                    {
                        var addSploit = true
                    }
                    else
                    {
                        var addSploit = false
                    }
                }
                else
                {
                    var addSploit = true
                }
                if (addSploit)
                {
                    //metadata todo
                    if (false)
                    {

                    }
                    else
                    {
                        data.sploits[filename] = {
                            type: path.extname(files[file]),
                            image: 'none.jpg',
                            description: 'hi lol bye',
                            creator: 'me >:D',
                            version: 'dunno m8',
                            filename: path.basename(files[file]).split('.')[0],
                            sysvers: [532, 540, 550, 551]
                        }
                    }
                }
            }
        }
        res.render('folder', data);
    });
});

module.exports = router;
